{% extends "base.html" %}

{% block title %}Quiz{% endblock %}

{% block content %}
<div class="container mt-4">
    <div class="row">
        <div class="col-12">
            <h2 class="mb-4 text-center">Interactive Quiz</h2>
        </div>
    </div>
    
    {% if quiz_content %}
        <div class="row">
            <div class="col-12">
                <div class="card shadow-lg mb-4">
                    <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
                        <h3 class="mb-0">Quiz on {{ topic }} ({{ difficulty }} level)</h3>
                        <div class="quiz-timer">
                            <span id="timer" class="badge bg-light text-dark">Time: <span id="time-value">00:00</span></span>
                        </div>
                    </div>
                    <div class="card-body">
                        <div id="quiz-container">
                            <!-- Quiz questions will be dynamically inserted here -->
                        </div>
                        
                        <div id="quiz-results" class="d-none">
                            <div class="text-center py-5">
                                <div class="mb-4">
                                    <i class="fas fa-trophy fa-3x text-warning"></i>
                                </div>
                                <h3 class="mb-3">Quiz Completed!</h3>
                                <div class="result-score display-4 mb-3">
                                    <span id="score-value">0</span>/<span id="total-questions">0</span>
                                </div>
                                <div class="progress mb-3" style="height: 25px;">
                                    <div id="score-progress" class="progress-bar" role="progressbar" style="width: 0%;">0%</div>
                                </div>
                                <p class="lead" id="score-message"></p>
                                <button id="restart-quiz" class="btn btn-primary btn-lg mt-3">
                                    <i class="fas fa-redo me-2"></i>Restart Quiz
                                </button>
                            </div>
                        </div>
                        
                        <div class="d-flex justify-content-between mt-4">
                            <button id="prev-question" class="btn btn-secondary" disabled>
                                <i class="fas fa-arrow-left me-2"></i>Previous
                            </button>
                            <div id="question-counter" class="align-self-center">
                                Question <span id="current-question">1</span> of <span id="total-question-count">0</span>
                            </div>
                            <button id="next-question" class="btn btn-primary">
                                Next<i class="fas fa-arrow-right ms-2"></i>
                            </button>
                            <button id="submit-quiz" class="btn btn-success d-none">
                                <i class="fas fa-check-circle me-2"></i>Submit Quiz
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    {% endif %}
    
    <div class="row">
        <div class="col-12">
            <div class="card shadow">
                <div class="card-header bg-info text-white">
                    <h4 class="mb-0">Generate a New Quiz</h4>
                </div>
                <div class="card-body">
                    <form method="post" id="quiz-form">
                        {% csrf_token %}
                        <div class="mb-3">
                            <label for="topic" class="form-label">Topic</label>
                            <input type="text" class="form-control form-control-lg" id="topic" name="topic" placeholder="Enter quiz topic (e.g., Python, History, Math)" required>
                        </div>
                        <div class="mb-3">
                            <label for="difficulty" class="form-label">Difficulty Level</label>
                            <select class="form-select form-select-lg" id="difficulty" name="difficulty" required>
                                <option value="">Select difficulty level</option>
                                <option value="beginner">Beginner</option>
                                <option value="intermediate">Intermediate</option>
                                <option value="advanced">Advanced</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label for="num_questions" class="form-label">Number of Questions</label>
                            <select class="form-select form-select-lg" id="num_questions" name="num_questions" required>
                                <option value="5">5 Questions</option>
                                <option value="10" selected>10 Questions</option>
                                <option value="15">15 Questions</option>
                                <option value="20">20 Questions</option>
                            </select>
                        </div>
                        <button type="submit" class="btn btn-primary btn-lg w-100">
                            <i class="fas fa-cogs me-2"></i>Generate Quiz
                        </button>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
    .quiz-question {
        display: none;
        animation: fadeIn 0.5s ease-in-out;
    }
    
    .quiz-question.active {
        display: block;
    }
    
    .answer-option {
        cursor: pointer;
        transition: all 0.3s ease;
        border: 2px solid #e9ecef;
        border-radius: 10px;
        padding: 15px;
        margin-bottom: 15px;
    }
    
    .answer-option:hover {
        background-color: #f8f9fa;
        border-color: #007bff;
        transform: translateY(-2px);
        box-shadow: 0 4px 8px rgba(0,0,0,0.1);
    }
    
    .answer-option.selected {
        background-color: #007bff;
        color: white;
        border-color: #007bff;
    }
    
    .answer-option.correct {
        background-color: #28a745;
        color: white;
        border-color: #28a745;
    }
    
    .answer-option.incorrect {
        background-color: #dc3545;
        color: white;
        border-color: #dc3545;
    }
    
    .result-score {
        font-weight: bold;
        color: #007bff;
    }
    
    .progress {
        border-radius: 12px;
    }
    
    .progress-bar {
        transition: width 1s ease-in-out;
    }
    
    .card {
        border: none;
        border-radius: 15px;
        overflow: hidden;
    }
    
    .card-header {
        border-radius: 15px 15px 0 0 !important;
    }
    
    .form-control-lg, .form-select-lg {
        border-radius: 10px;
        padding: 12px 15px;
    }
    
    .btn-lg {
        border-radius: 10px;
        padding: 12px 20px;
    }
    
    @keyframes fadeIn {
        from { opacity: 0; transform: translateY(20px); }
        to { opacity: 1; transform: translateY(0); }
    }
    
    .quiz-timer {
        font-size: 1rem;
    }
    
    .badge {
        font-size: 0.9rem;
    }
    
    .pre-formatted {
        white-space: pre-wrap;
        font-family: monospace;
        background-color: #f8f9fa;
        padding: 15px;
        border-radius: 8px;
        border: 1px solid #e9ecef;
    }
    
    .parsing-message {
        background-color: #fff3cd;
        border: 1px solid #ffeaa7;
        border-radius: 8px;
        padding: 15px;
        margin-bottom: 20px;
        color: #856404;
    }
</style>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Parse quiz content if available
        {% if quiz_content %}
            // Display the raw quiz content in case parsing fails
            const quizContainer = document.getElementById('quiz-container');
            const preElement = document.createElement('pre');
            preElement.className = 'pre-formatted';
            preElement.textContent = `{{ quiz_content }}`;
            quizContainer.appendChild(preElement);
            
            // Try to parse the quiz content
            try {
                const quizData = parseQuizContent(`{{ quiz_content|escapejs }}`);
                if (quizData && quizData.length > 0) {
                    // Remove the raw content display
                    quizContainer.innerHTML = '';
                    initializeQuiz(quizData);
                } else {
                    // Show parsing message
                    const parsingMessage = document.createElement('div');
                    parsingMessage.className = 'parsing-message';
                    parsingMessage.innerHTML = `
                        <h5>Quiz Format Not Recognized</h5>
                        <p>We're having trouble parsing the quiz content. The AI-generated quiz doesn't follow the expected format.</p>
                        <p>You can still take the quiz by reading the questions below and keeping track of your answers manually.</p>
                    `;
                    quizContainer.insertBefore(parsingMessage, preElement);
                }
            } catch (error) {
                console.error('Error parsing quiz content:', error);
                // Show parsing error message
                const parsingMessage = document.createElement('div');
                parsingMessage.className = 'parsing-message';
                parsingMessage.innerHTML = `
                    <h5>Quiz Parsing Error</h5>
                    <p>We encountered an error while trying to parse the quiz content: ${error.message}</p>
                    <p>You can still take the quiz by reading the questions below and keeping track of your answers manually.</p>
                `;
                quizContainer.insertBefore(parsingMessage, preElement);
            }
        {% endif %}
        
        // Timer functionality
        let startTime = new Date();
        let timerInterval;
        
        function startTimer() {
            timerInterval = setInterval(updateTimer, 1000);
        }
        
        function updateTimer() {
            const currentTime = new Date();
            const elapsedTime = Math.floor((currentTime - startTime) / 1000);
            const minutes = Math.floor(elapsedTime / 60);
            const seconds = elapsedTime % 60;
            document.getElementById('time-value').textContent = 
                `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
        }
        
        // Parse quiz content from text format
        function parseQuizContent(content) {
            try {
                // Improved parser that handles multiple formats
                const questions = [];
                const lines = content.split('\n');
                let currentQuestion = null;
                
                // Regular expressions for different formats
                const questionRegex = /^(?:Q\d*[:.]\s*|\d+[.)]\s*)(.+)$/i;
                const optionRegex = /^[A-D][.)]\s*(.+)$/i;
                const correctAnswerRegex = /correct\s+answer[:.]\s*([A-D])/i;
                
                for (let i = 0; i < lines.length; i++) {
                    const line = lines[i].trim();
                    if (!line) continue;
                    
                    // Check for question
                    const questionMatch = line.match(questionRegex);
                    if (questionMatch) {
                        // Save previous question if exists
                        if (currentQuestion) {
                            questions.push(currentQuestion);
                        }
                        
                        // Create new question
                        currentQuestion = {
                            question: questionMatch[1],
                            options: [],
                            correctAnswer: null
                        };
                        continue;
                    }
                    
                    // Check for options
                    const optionMatch = line.match(optionRegex);
                    if (optionMatch && currentQuestion) {
                        currentQuestion.options.push(optionMatch[1]);
                        continue;
                    }
                    
                    // Check for correct answer
                    const correctAnswerMatch = line.match(correctAnswerRegex);
                    if (correctAnswerMatch && currentQuestion) {
                        const answerLetter = correctAnswerMatch[1].toUpperCase();
                        const answerIndex = ['A', 'B', 'C', 'D'].indexOf(answerLetter);
                        if (answerIndex !== -1) {
                            currentQuestion.correctAnswer = answerIndex;
                        }
                        continue;
                    }
                }
                
                // Add the last question
                if (currentQuestion) {
                    questions.push(currentQuestion);
                }
                
                return questions;
            } catch (error) {
                console.error('Error parsing quiz content:', error);
                return null;
            }
        }
        
        // Initialize quiz with questions
        function initializeQuiz(questions) {
            const quizContainer = document.getElementById('quiz-container');
            quizContainer.innerHTML = '';
            
            questions.forEach((q, index) => {
                const questionDiv = document.createElement('div');
                questionDiv.className = 'quiz-question';
                if (index === 0) questionDiv.classList.add('active');
                
                let optionsHtml = '';
                q.options.forEach((option, optionIndex) => {
                    optionsHtml += `
                        <div class="answer-option" data-index="${optionIndex}">
                            <div class="d-flex">
                                <div class="me-3 fw-bold">${String.fromCharCode(65 + optionIndex)}.</div>
                                <div>${option}</div>
                            </div>
                        </div>
                    `;
                });
                
                questionDiv.innerHTML = `
                    <h4 class="mb-4">Question ${index + 1}</h4>
                    <p class="lead mb-4">${q.question}</p>
                    <div class="options-container">
                        ${optionsHtml}
                    </div>
                `;
                
                quizContainer.appendChild(questionDiv);
            });
            
            // Update total question count
            document.getElementById('total-question-count').textContent = questions.length;
            document.getElementById('total-questions').textContent = questions.length;
            
            // Add event listeners to answer options
            document.querySelectorAll('.answer-option').forEach(option => {
                option.addEventListener('click', function() {
                    // Remove selected class from all options in this question
                    this.parentElement.querySelectorAll('.answer-option').forEach(opt => {
                        opt.classList.remove('selected');
                    });
                    
                    // Add selected class to clicked option
                    this.classList.add('selected');
                    
                    // Store the selected answer
                    const questionIndex = Array.from(quizContainer.children).indexOf(this.closest('.quiz-question'));
                    const optionIndex = parseInt(this.getAttribute('data-index'));
                    questions[questionIndex].userAnswer = optionIndex;
                });
            });
            
            // Initialize navigation
            initializeNavigation(questions);
            
            // Start timer
            startTime = new Date();
            startTimer();
        }
        
        // Initialize navigation controls
        function initializeNavigation(questions) {
            const prevBtn = document.getElementById('prev-question');
            const nextBtn = document.getElementById('next-question');
            const submitBtn = document.getElementById('submit-quiz');
            const currentQuestionSpan = document.getElementById('current-question');
            const quizContainer = document.getElementById('quiz-container');
            
            let currentQuestionIndex = 0;
            
            function updateNavigation() {
                currentQuestionSpan.textContent = currentQuestionIndex + 1;
                
                // Update button states
                prevBtn.disabled = currentQuestionIndex === 0;
                
                if (currentQuestionIndex === questions.length - 1) {
                    nextBtn.classList.add('d-none');
                    submitBtn.classList.remove('d-none');
                } else {
                    nextBtn.classList.remove('d-none');
                    submitBtn.classList.add('d-none');
                }
                
                // Show current question
                document.querySelectorAll('.quiz-question').forEach((question, index) => {
                    if (index === currentQuestionIndex) {
                        question.classList.add('active');
                    } else {
                        question.classList.remove('active');
                    }
                });
            }
            
            prevBtn.addEventListener('click', function() {
                if (currentQuestionIndex > 0) {
                    currentQuestionIndex--;
                    updateNavigation();
                }
            });
            
            nextBtn.addEventListener('click', function() {
                if (currentQuestionIndex < questions.length - 1) {
                    currentQuestionIndex++;
                    updateNavigation();
                }
            });
            
            submitBtn.addEventListener('click', function() {
                calculateScore(questions);
            });
            
            // Initialize
            updateNavigation();
        }
        
        // Calculate and display score
        function calculateScore(questions) {
            let correctAnswers = 0;
            
            questions.forEach((q, index) => {
                if (q.userAnswer === q.correctAnswer) {
                    correctAnswers++;
                }
            });
            
            const score = Math.round((correctAnswers / questions.length) * 100);
            
            // Display results
            document.getElementById('quiz-container').classList.add('d-none');
            document.getElementById('quiz-results').classList.remove('d-none');
            
            document.getElementById('score-value').textContent = correctAnswers;
            document.getElementById('score-progress').style.width = `${score}%`;
            document.getElementById('score-progress').textContent = `${score}%`;
            
            // Set score message
            const scoreMessage = document.getElementById('score-message');
            if (score >= 80) {
                scoreMessage.textContent = 'Excellent! You have a strong understanding of this topic.';
                scoreMessage.className = 'lead text-success';
            } else if (score >= 60) {
                scoreMessage.textContent = 'Good job! You have a decent understanding of this topic.';
                scoreMessage.className = 'lead text-primary';
            } else if (score >= 40) {
                scoreMessage.textContent = 'Not bad, but there\'s room for improvement.';
                scoreMessage.className = 'lead text-warning';
            } else {
                scoreMessage.textContent = 'You might want to review this topic again.';
                scoreMessage.className = 'lead text-danger';
            }
            
            // Stop timer
            clearInterval(timerInterval);
        }
        
        // Restart quiz
        document.getElementById('restart-quiz').addEventListener('click', function() {
            document.getElementById('quiz-container').classList.remove('d-none');
            document.getElementById('quiz-results').classList.add('d-none');
            
            // Reset all answers
            document.querySelectorAll('.answer-option').forEach(option => {
                option.classList.remove('selected', 'correct', 'incorrect');
            });
            
            // Reset navigation
            document.getElementById('prev-question').disabled = true;
            document.getElementById('next-question').classList.remove('d-none');
            document.getElementById('submit-quiz').classList.add('d-none');
            
            // Reset question counter
            document.getElementById('current-question').textContent = '1';
            
            // Restart timer
            startTime = new Date();
            startTimer();
        });
    });
</script>
{% endblock %}
